<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Leaflet Story Demo with Linked Chapters & Markers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: #222;
      background: #f5f5f5;
    }

    .app {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .narrative {
      width: 40%;
      max-width: 520px;
      min-width: 320px;
      overflow-y: auto;
      padding: 1.5rem 1.5rem 3rem;
      background: #ffffff;
      box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
      scroll-behavior: smooth;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .narrative::-webkit-scrollbar {
      display: none;
    }

    .narrative-header {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.75rem;
    }
    .narrative-header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.6rem;
    }
    .narrative-header p {
      margin: 0;
      font-size: 0.95rem;
      color: #666;
    }

    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin: 1rem 0 1.5rem;
    }
    .thumbnail {
      cursor: pointer;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }
    .thumbnail:hover {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    .thumbnail-image {
      width: 100%;
      aspect-ratio: 4 / 3;
      background-size: cover;
      background-position: center;
      background-color: #ddd;
      flex-shrink: 0;
    }
    .thumbnail-meta {
      padding: 0.4rem 0.5rem 0.6rem;
    }
    .thumbnail-keystone {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 0.2rem;
    }
    .thumbnail-title {
      font-size: 0.85rem;
      font-weight: 600;
      line-height: 1.3;
      color: #222;
    }

    .chapter-detail {
      display: none;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1rem;
    }
    .chapter-detail.active {
      display: block;
    }
    .chapter-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .chapter-detail-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }
    .chapter-detail-close {
      padding: 0.25rem 0.6rem;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
    }
    .chapter-detail-close:hover {
      background: #eee;
    }
    .chapter-detail-image {
      width: 100%;
      height: 320px;
      background-size: cover;
      background-position: center;
      background-color: #ddd;
      margin-bottom: 0.75rem;
    }
    .chapter-detail p {
      margin: 0 0 0.5rem;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    #map {
      flex: 1;
      height: 100vh;
    }

    @media (max-width: 800px) {
      .app {
        flex-direction: column;
      }
      .narrative {
        width: 100%;
        max-width: none;
        height: 45vh;
      }
      #map {
        height: 55vh;
      }
      .thumbnail-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="narrative" id="narrative">
      <header class="narrative-header">
        <h1>Demo Story Map</h1>
        <p>
          A simple scrolling story with placeholder text, images, markers, and a Leaflet map.
        </p>
      </header>

      <div id="thumbnail-container">
        <div id="thumbnail-grid" class="thumbnail-grid"></div>
        <section id="chapter-detail" class="chapter-detail" aria-live="polite"></section>
      </div>
    </aside>
    <div id="map"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const storyConfig = {
      title: "Hedgerow Marathon story map - conceptual demo",
      subtitle:
        "A simple scrolling story map tour: geo-located points on a dynamic map, each associated with media comprising of image and text.",
      mapDefaults: {
        center: [52.881, 0.680],
        zoom: 12
      },
      chapters: [
        {
          id: "chapter1",
          keystone:"Stories from Farmers and Landowners",
          title: "Hedge 1",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/6/65/Flowering_gorse_in_hedgerow_-_geograph.org.uk_-_1151811.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.772509,
          lng: 0.624161,
          zoom: 14,
          markerLabel: "Hedge 1"
        },
        {
          id: "chapter2",
          keystone:"Hedgerow Species",
          title: "Hedge 2",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Neatly_trimmed_hedgerows_-_geograph.org.uk_-_615043.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.812357,
          lng: 0.632401,
          zoom: 14,
          markerLabel: "Hedge 2"
        },
        {
          id: "chapter3",
          keystone:"Hedgerow Species",
          title: "Hedge 3",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Neatly_trimmed_hedgerows_-_geograph.org.uk_-_615043.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.821898,
          lng: 0.603561,
          zoom: 14,
          markerLabel: "Hedge 3"
        },
        {
          id: "chapter4",
          keystone:"Stories from Farmers and Landowners",
          title: "Hedge 4",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/6/69/Hedgerow_separating_fields_-_geograph.org.uk_-_715273.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.845535,
          lng: 0.602188,
          zoom: 16,
          markerLabel: "Hedge 4"
        },
        {
          id: "chapter5",
          keystone:"Hedgerow Species",
          title: "Hedge 5",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Neatly_trimmed_hedgerows_-_geograph.org.uk_-_615043.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.864187,
          lng: 0.651627,
          zoom: 16,
          markerLabel: "Hedge 5"
        },
        {
          id: "chapter6",
          keystone:"Hedgerow Management",
          title: "Hedge 6",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/4/4d/Field_and_hedgerow%2C_Harling_-_geograph.org.uk_-_7915932.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.875374,
          lng: 0.681839,
          zoom: 14,
          markerLabel: "Hedge 6"
        },
        {
          id: "chapter7",
          keystone:"Hedgerow Species",
          title: "Hedge 7",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Neatly_trimmed_hedgerows_-_geograph.org.uk_-_615043.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.910161,
          lng: 0.695572,
          zoom: 14,
          markerLabel: "Hedge 7"
        },
        {
          id: "chapter8",
          keystone:"Hedgerow Management",
          title: "Hedge 8",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/4/42/Hedgerow_south_of_Paston_Green_-_geograph.org.uk_-_5886102.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.92175,
          lng: 0.725098,
          zoom: 14,
          markerLabel: "Hedge 8"
        },
        {
          id: "chapter9",
          keystone:"Hedgerow Species",
          title: "Hedge 9",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Neatly_trimmed_hedgerows_-_geograph.org.uk_-_615043.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.946987,
          lng: 0.74295,
          zoom: 14,
          markerLabel: "Hedge 9"
        },
        {
          id: "chapter10",
          keystone:"Hedgerow Management",
          title: "Hedge 10",
          imageUrl: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Neatly_trimmed_hedgerows_-_geograph.org.uk_-_615043.jpg",
          paragraphs: [
            "Hedgerows in Norfolk are vital ribbons of habitat threading through an intensively farmed landscape, providing food, shelter and nesting sites for farmland birds, small mammals and countless insects while linking up woods, ponds and grasslands as safe wildlife corridors. They also help protect Norfolk’s light soils from erosion, slow down run-off and filter water, and, as living historic boundaries, they shape the character of lanes and fields, making their careful protection and sympathetic management a key part of nature recovery in the county.",
            "Photo credit: Evelyn Simak / Hedgerow and trees / CC BY-SA 2.0"
          ],
          lat: 52.963552,
          lng: 0.75737,
          zoom: 14,
          markerLabel: "Hedge 10"
        }
      ]
    };

    const narrativeEl = document.getElementById("narrative");
    const headerTitleEl = narrativeEl.querySelector(".narrative-header h1");
    const headerSubtitleEl = narrativeEl.querySelector(".narrative-header p");
    if (headerTitleEl) headerTitleEl.textContent = storyConfig.title;
    if (headerSubtitleEl) headerSubtitleEl.textContent = storyConfig.subtitle;

    const thumbnailGridEl = document.getElementById("thumbnail-grid");
    const chapterDetailEl = document.getElementById("chapter-detail");

    // Build thumbnail grid
    storyConfig.chapters.forEach((cfg) => {
      const thumb = document.createElement("button");
      thumb.className = "thumbnail";
      thumb.type = "button";
      thumb.setAttribute("data-chapter-id", cfg.id);

      const imgDiv = document.createElement("div");
      imgDiv.className = "thumbnail-image";
      imgDiv.style.backgroundImage = `url('${cfg.imageUrl}')`;
      thumb.appendChild(imgDiv);

      const meta = document.createElement("div");
      meta.className = "thumbnail-meta";

      const ks = document.createElement("div");
      ks.className = "thumbnail-keystone";
      ks.textContent = cfg.keystone;
      meta.appendChild(ks);

      const title = document.createElement("div");
      title.className = "thumbnail-title";
      title.textContent = cfg.title;
      meta.appendChild(title);

      thumb.appendChild(meta);
      thumbnailGridEl.appendChild(thumb);
    });

    const chapters = {};
    storyConfig.chapters.forEach((cfg) => {
      chapters[cfg.id] = {
        center: [cfg.lat, cfg.lng],
        zoom: cfg.zoom,
        label: cfg.markerLabel,
        keystone: cfg.keystone
      };
    });

    const map = L.map("map", {
      center: storyConfig.mapDefaults.center,
      zoom: storyConfig.mapDefaults.zoom,
      scrollWheelZoom: false,
      preferCanvas: true // canvas renderer for performance [web:21][web:12]
    });

    const mapContainer = document.getElementById("map");
    mapContainer.addEventListener("wheel", (event) => {
      narrativeEl.scrollTop += event.deltaY;
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19,
    }).addTo(map);

    // --- REPLACEMENT START: SVG OVERLAY IMPLEMENTATION ---
    const svgString = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"
     data-north="52.96459567535271" 
     data-south="52.773096245936976" 
     data-east="0.7613503932952882" 
     data-west="0.5929183959960939">
    <polyline points="18.9057,100.0000 18.2432,97.3429 14.7016,97.5869 14.7016,95.2892 15.8864,95.3773 16.5616,94.0761 17.3259,93.1138 17.5553,92.2600 21.6574,90.7150 21.9122,90.3626 20.6892,88.9262 18.8547,86.2297 20.0013,85.7826 21.1733,85.4574 22.4473,85.3761 23.1607,85.5251 24.2563,83.8722 23.9760,83.5200 24.9188,82.0163 25.6067,82.1653 25.9889,81.6911 26.4730,81.6505 27.5432,80.9054 24.5876,80.0520 25.8615,78.9413 23.0078,78.6163 20.6128,78.1016 19.0076,77.0045 17.4024,77.2618 17.3769,77.3600 16.1603,77.7054 16.2622,77.8137 13.4085,78.7890 12.9117,78.2370 8.2298,78.7382 6.6501,75.5283 5.1468,71.6824 8.9178,72.6438 3.2868,64.9131 4.2550,64.8183 4.4334,64.9807 6.1405,64.8318 6.5482,64.4664 6.5737,63.8843 8.6120,62.7338 2.9811,60.7306 0.0000,56.4407 3.7964,55.4665 2.9811,53.2204 7.3126,54.4517 8.1279,52.3816 11.8224,53.0581 11.7205,51.6781 14.7016,52.5575 20.0268,51.8675 20.3580,52.3816 20.9950,52.2328 21.3007,52.4899 22.9824,52.2869 22.2944,51.4346 24.8678,50.8935 24.9315,51.0829 27.6960,50.6770 28.0527,51.6984 32.9448,51.5564 32.3078,52.3005 38.0916,52.5304 37.8623,53.2746 42.1428,53.2475 43.6206,53.4099 46.5762,53.1799 46.6272,52.3275 45.3277,52.3140 45.3787,51.1911 43.9009,51.0017 44.7927,50.0006 45.7354,50.3118 49.6847,49.0402 54.8060,46.4566 53.1499,45.7804 52.4874,44.6713 52.2326,43.5488 56.8762,42.7645 56.1564,41.8753 54.2328,42.4162 54.0862,41.0673 55.6787,40.9084 54.9016,39.2520 59.3159,38.8565 59.0866,38.0994 60.9466,37.8966 60.8446,35.5712 60.9211,34.0300 60.6918,32.0565 62.9085,32.0024 62.2205,29.5154 59.4433,29.8803 60.4879,28.8261 60.4879,26.9206 63.8002,26.6638 66.5265,26.4341 69.3547,25.5152 67.9534,23.3532 72.5397,22.8262 72.8709,20.8672 77.1005,21.1644 76.7437,22.6101 81.3555,22.8533 83.1900,22.7046 86.8336,21.9075 86.1966,20.8807 92.1333,20.1106 90.4007,18.9488 92.7702,17.8681 91.9294,17.0981 91.9039,16.1796 90.9612,15.1665 90.8083,13.8429 88.6426,14.0050 87.8273,11.4524 84.8716,10.4936 89.2286,9.3053 89.6618,8.8597 89.5598,8.0900 93.5856,8.1305 93.8149,5.6732 94.7067,5.7272 95.2927,5.7137 95.2927,4.9711 95.7004,4.9306 95.3946,4.2421 96.0316,4.2286 95.9297,3.5536 97.8916,3.6076 97.6495,2.4466 97.4648,2.0281 95.6940,1.7278 94.4965,1.1001 94.5984,0.5467 94.3945,0.2092 94.5538,0.0101 95.4965,0.0877 97.4266,0.6951 97.3629,0.0776 100.0000,0.0000" 
              style="fill:none;stroke:#237025;stroke-width:5;stroke-opacity:1.0;stroke-linecap:round;stroke-linejoin:round;vector-effect:non-scaling-stroke" />
</svg>`;

    // Parse SVG string to DOM element
    const parser = new DOMParser();
    const svgDoc = parser.parseFromString(svgString, "image/svg+xml");
    const svgElement = svgDoc.documentElement;

    // Extract bounds from data attributes (South-West to North-East)
    const south = parseFloat(svgElement.getAttribute('data-south'));
    const west = parseFloat(svgElement.getAttribute('data-west'));
    const north = parseFloat(svgElement.getAttribute('data-north'));
    const east = parseFloat(svgElement.getAttribute('data-east'));
    const svgBounds = L.latLngBounds([[south, west], [north, east]]);

    // Add SVG Overlay
    L.svgOverlay(svgElement, svgBounds, {
      opacity: 0.8,
      interactive: false
    }).addTo(map);

    // Compute simple per-chapter bounds for animation
    const chapterBounds = {};
    Object.entries(chapters).forEach(([id, cfg]) => {
      const padding = 0.01;
      const b = L.latLngBounds(
        [cfg.center[0] - padding, cfg.center[1] - padding],
        [cfg.center[0] + padding, cfg.center[1] + padding]
      );
      chapterBounds[id] = b;
    });
    // --- REPLACEMENT END ---

    const baseMarkerIconUrl = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png";
    const baseMarkerShadowUrl = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png";

    function createColorIcon(color) {
      return L.icon({
        iconUrl: baseMarkerIconUrl,
        shadowUrl: baseMarkerShadowUrl,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
        className: `marker-${color}`
      });
    }

    const markerIcons = {
      red: createColorIcon("red"),
      green: createColorIcon("green"),
      blue: createColorIcon("blue"),
      default: createColorIcon("default")
    };

    const styleEl = document.createElement("style");
    styleEl.textContent = `
      .leaflet-marker-icon.marker-red { filter: hue-rotate(330deg) saturate(1.4); }
      .leaflet-marker-icon.marker-green { filter: hue-rotate(90deg) saturate(1.4); }
      .leaflet-marker-icon.marker-blue { filter: hue-rotate(220deg) saturate(1.4); }
      .leaflet-marker-icon.marker-default { filter: none; }
    `;
    document.head.appendChild(styleEl);

    function keystoneToColor(keystone) {
      if (keystone === "Hedgerow Management") return "red";
      if (keystone === "Hedgerow Species") return "green";
      if (keystone === "Stories from Farmers and Landowners") return "blue";
      return "default";
    }

    const markers = {};
    Object.entries(chapters).forEach(([id, cfg]) => {
      const colorKey = keystoneToColor(cfg.keystone);
      const marker = L.marker(cfg.center, {
        icon: markerIcons[colorKey] || markerIcons.default
      })
        .addTo(map)
        .bindPopup(`<strong>${cfg.label}</strong>`);

      marker.on("click", () => {
        openChapterDetail(id);
      });

      markers[id] = marker;
    });

    let activeChapterId = null;

    // Helper to decide whether two chapters are "far apart"
    function isFarMove(fromCenter, toCenter) {
      if (!fromCenter || !toCenter) return false;
      const dLat = fromCenter[0] - toCenter[0];
      const dLng = fromCenter[1] - toCenter[1];
      const dist = Math.sqrt(dLat * dLat + dLng * dLng);
      return dist > 0.05; // tweak threshold as needed
    }

    function setActiveChapter(chapterId) {
      if (chapterId === activeChapterId) return;

      const previousId = activeChapterId;
      activeChapterId = chapterId;

      const cfg = chapters[chapterId];
      if (cfg) {
        const prevCfg = previousId ? chapters[previousId] : null;
        const far = prevCfg && isFarMove(prevCfg.center, cfg.center);

        if (far && chapterBounds[chapterId]) {
          // For big jumps, use flyToBounds for smoother long animation [web:108]
          map.flyToBounds(chapterBounds[chapterId], {
            duration: 1.6
          });
        } else {
          // For nearby moves, use flyTo center/zoom
          map.flyTo(cfg.center, cfg.zoom, { duration: 1.4 });
        }
      }

      Object.values(markers).forEach((m) => m.closePopup());
      if (markers[chapterId]) {
        markers[chapterId].openPopup();
      }
    }

    function hoverChapter(chapterId) {
      const cfg = chapters[chapterId];
      if (!cfg) return;

      // Hover uses a small zoom delta; keep using flyTo for responsiveness
      map.flyTo(cfg.center, storyConfig.mapDefaults.zoom, { duration: 1.0 });

      Object.values(markers).forEach((m) => m.closePopup());
      if (markers[chapterId]) {
        markers[chapterId].openPopup();
      }
    }

    function openChapterDetail(chapterId) {
      const cfg = storyConfig.chapters.find((c) => c.id === chapterId);
      if (!cfg) return;

      chapterDetailEl.innerHTML = "";

      const header = document.createElement("div");
      header.className = "chapter-detail-header";

      const titleEl = document.createElement("h2");
      titleEl.textContent = cfg.title;
      header.appendChild(titleEl);

      const closeBtn = document.createElement("button");
      closeBtn.type = "button";
      closeBtn.className = "chapter-detail-close";
      closeBtn.textContent = "CLOSE";
      closeBtn.addEventListener("click", () => {
        chapterDetailEl.classList.remove("active");
        thumbnailGridEl.style.display = "grid";
      });
      header.appendChild(closeBtn);

      chapterDetailEl.appendChild(header);

      const imgDiv = document.createElement("div");
      imgDiv.className = "chapter-detail-image";
      imgDiv.style.backgroundImage = `url('${cfg.imageUrl}')`;
      chapterDetailEl.appendChild(imgDiv);

      cfg.paragraphs.forEach((text) => {
        const p = document.createElement("p");
        p.textContent = text;
        chapterDetailEl.appendChild(p);
      });

      thumbnailGridEl.style.display = "none";
      chapterDetailEl.classList.add("active");

      setActiveChapter(chapterId);
    }

    thumbnailGridEl.addEventListener("mouseover", (event) => {
      const thumb = event.target.closest(".thumbnail");
      if (!thumb) return;
      const chapterId = thumb.getAttribute("data-chapter-id");
      if (!chapterId) return;
      hoverChapter(chapterId);
    });

    thumbnailGridEl.addEventListener("click", (event) => {
      const thumb = event.target.closest(".thumbnail");
      if (!thumb) return;
      const chapterId = thumb.getAttribute("data-chapter-id");
      if (!chapterId) return;
      openChapterDetail(chapterId);
    });

    map.setView(storyConfig.mapDefaults.center, storyConfig.mapDefaults.zoom);
  </script>
</body>
</html>
